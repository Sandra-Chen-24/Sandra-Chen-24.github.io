# helmfile -e platform_bbin_dev template --debug > test.yaml
# helmfile -e platform_bbin_dev apply
resources:
  gateway:
    enabled: true
    spec:
      apiVersion: gateway.networking.k8s.io/v1
      kind: Gateway
      metadata: { name: "{{ .Release.Name }}" }
      spec:
        addresses:
          - type: NamedAddress
            value: gateway-hall-ccd
          - type: NamedAddress
            value: gateway-hall-ccd-ipv6
        gatewayClassName: gke-l7-global-external-managed
        listeners:
          - name: http
            protocol: HTTP
            port: 80
            allowedRoutes: { kinds: [{ kind: HTTPRoute }] }
          - name: https
            protocol: HTTPS
            port: 443
            allowedRoutes: { kinds: [{ kind: HTTPRoute }] }
            tls:
              mode: Terminate
              options:
                # https://console.cloud.google.com/security/ccm/lbCertificates/details/hall-vir888-com-20251125?project=gcp-20220425-010
                networking.gke.io/pre-shared-certs: hall-chpygdpm-com-20260706, hall-epbyofzj-com-20260706,  hall-wpgknmzl-com-20261003

  httproute:
    enabled: true
    spec:
      apiVersion: gateway.networking.k8s.io/v1
      kind: HTTPRoute
      metadata: { name: "{{ .Release.Name }}" }
      spec:
        parentRefs: [{ name: "{{ .Release.Name }}" }]
        hostnames:
          - hall.chpygdpm.com
          - hall.epbyofzj.com
          - hall.wpgknmzl.com
        rules:
          - matches:
              - headers:
                  - { name: Referer, value: https://hall.vir888.com }
            filters:
              - type: RequestHeaderModifier
                requestHeaderModifier:
                  add:
                    - { name: Site-Server-Alias, value: bbin168 }
            backendRefs:
              - name: hall-nginx-proxy-ci-neg
                port: 80
          - matches:
              - headers:
                  - { name: Referer, value: https://hall.dctest999.com }
            filters:
              - type: RequestHeaderModifier
                requestHeaderModifier:
                  add:
                    - { name: Site-Server-Alias, value: dctest }
            backendRefs:
              - name: hall-nginx-proxy-ci-neg
                port: 80

  httproute2:
    enabled: true
    spec: |
      {{- range $i := until 20 }}
      apiVersion: gateway.networking.k8s.io/v1
      kind: HTTPRoute
      metadata: { name: "{{ $.Release.Name }}-{{ $i }}" }
      spec:
        parentRefs: [{ name: "{{ $.Release.Name }}" }]
        hostnames:
          - hall.chpygdpm.com
          - hall.epbyofzj.com
          - hall.wpgknmzl.com
        rules:
          {{- range $j := until 10 }}
          - matches:
              - headers:
                  - { name: Referer, value: https://hall-{{ $i }}-{{ $j }}.vir888.com }
            filters:
              - type: RequestHeaderModifier
                requestHeaderModifier:
                  add:
                    - { name: Site-Server-Alias, value: bbin168-{{ $i }}-{{ $j }} }
            backendRefs:
              - name: hall-nginx-proxy-ci-neg
                port: 80
          {{- end }}
      ---
      {{- end }}
